<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ujian Online CBT</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; user-select: none; -webkit-user-select: none; }
        .hidden { display: none !important; }
        
        /* Card Styles */
        .card-dash { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .card-mapel { transition: transform 0.2s; border: none; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: white; }
        .card-mapel:hover { transform: translateY(-3px); }
        .card-done { background-color: #e9ecef; color: #6c757d; box-shadow: none; transform: none !important; }

        /* Soal Styles */
        .soal-text img { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; border: 1px solid #ddd; }
        .opsi-btn { text-align: left; white-space: normal; margin-bottom: 10px; border: 1px solid #dee2e6; transition: 0.2s; padding: 12px 15px; }
        .opsi-btn:hover { background-color: #f8f9fa; border-color: #0d6efd; }
        .opsi-btn.active { background-color: #0d6efd; color: white; border-color: #0d6efd; font-weight: bold; }
        
        /* Timer Sticky */
        .sticky-timer { position: sticky; top: 0; z-index: 1000; background: #fff; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-bottom: 1px solid #ddd; }
        
        /* Navigasi Buttons Bawah */
        .nav-buttons-container { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        .btn-nav { min-width: 120px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#"><i class="fas fa-laptop-code"></i> CBT ONLINE</a>
            <div class="d-flex align-items-center text-white" id="user-info" style="display:none !important;">
                <div class="me-3 text-end" style="line-height: 1.2;">
                    <span class="d-block fw-bold small" id="namaSiswaDisplay">Siswa</span>
                    <span class="d-block small opacity-75" id="kelasSiswaDisplay">-</span>
                </div>
                <button onclick="logout()" class="btn btn-sm btn-light text-primary fw-bold">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container main-container mb-5">
        
        <div id="view-login" class="row justify-content-center" style="margin-top: 60px;">
            <div class="col-md-5 col-lg-4">
                <div class="card card-dash p-4">
                    <div class="text-center mb-4">
                        <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                            <i class="fas fa-user-graduate fa-2x"></i>
                        </div>
                        <h4 class="mt-3 fw-bold">Login Siswa</h4>
                        <p class="text-muted small">Silakan masuk untuk memulai ujian</p>
                    </div>
                    
                    <form id="formLogin">
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">USERNAME</label>
                            <input type="text" id="username" class="form-control" placeholder="NIS / Username" required autocomplete="off">
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold small text-muted">PASSWORD</label>
                            <div class="input-group">
                                <input type="password" id="password" class="form-control" placeholder="Password" required>
                                <button class="btn btn-outline-secondary" type="button" id="btnTogglePass">
                                    <i class="fas fa-eye" id="iconPass"></i>
                                </button>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">MASUK <i class="fas fa-sign-in-alt"></i></button>
                    </form>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="hidden">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold text-dark mb-0">Daftar Ujian</h4>
                <button onclick="loadMapel()" class="btn btn-sm btn-outline-primary"><i class="fas fa-sync"></i> Refresh</button>
            </div>
            
            <div class="row g-3" id="listMapel">
                </div>
        </div>

        <div id="view-ujian" class="hidden">
            <div class="sticky-timer rounded mb-3 d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-primary" id="mapel-label">MAPEL</span>
                    <span class="badge bg-warning text-dark">No. <span id="no-soal">1</span></span>
                </div>
                <div class="fw-bold text-danger fs-5 font-monospace">
                    <i class="fas fa-clock"></i> <span id="timer">00:00:00</span>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="card card-dash p-4 h-100">
                        <div class="soal-text fs-5 mb-4" id="soal-container" style="line-height: 1.6;">
                            Loading soal...
                        </div>
                        
                        <div class="d-grid gap-2" id="opsi-container">
                            </div>

                        <div class="nav-buttons-container">
                            <button id="btn-prev" onclick="navigasiSoal(-1)" class="btn btn-outline-secondary btn-nav">
                                <i class="fas fa-arrow-left"></i> Sebelumnya
                            </button>
                            
                            <button id="btn-next" onclick="navigasiSoal(1)" class="btn btn-primary btn-nav">
                                Selanjutnya <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card card-dash p-3">
                        <h6 class="fw-bold mb-3 small text-muted text-uppercase">Navigasi Nomor</h6>
                        <div class="d-flex flex-wrap gap-2 justify-content-center" id="nav-soal">
                            </div>
                        <hr>
                        <div class="d-grid gap-2">
                            <button class="btn btn-warning text-dark fw-bold" onclick="raguRagu()">
                                <i class="fas fa-bookmark"></i> Ragu-ragu
                            </button>
                            <button class="btn btn-success fw-bold py-2" onclick="selesaiUjian()">
                                <i class="fas fa-paper-plane"></i> KIRIM JAWABAN
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // --- KONFIGURASI ---
        // GANTI URL INI DENGAN URL DEPLOYMENT WEB APP ANDA YANG TERBARU
        const API_URL = 'https://script.google.com/macros/s/AKfycbzZ2xDc66XiCaMNJifFPY1y7BN7V7G4cYq_L4BjGI55HYSf6DNsp15iFtsyxBzTOo0/exec'; 

        // --- STATE MANAGEMENT ---
        let state = {
            user: null,    
            mapel: null,   
            soal: [],      
            jawaban: {},   
            durasi: 0,     
            timerInterval: null,
            isUjianAktif: false, 
            pelanggaran: 0       
        };

        let currentSoalIndex = 0;

        // --- 0. SCRIPT LIHAT PASSWORD (BARU) ---
        document.getElementById('btnTogglePass').addEventListener('click', function() {
            const passInput = document.getElementById('password');
            const icon = document.getElementById('iconPass');
            
            if (passInput.type === 'password') {
                passInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash'); // Mata dicoret
            } else {
                passInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye'); // Mata biasa
            }
        });

        // --- 1. LOGIN SYSTEM ---
        document.getElementById('formLogin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            Swal.fire({ title: 'Memeriksa akun...', didOpen: () => Swal.showLoading() });

            try {
                const res = await apiRequest({ action: 'login', payload: { username: u, password: p } });
                
                if (res.status === 'success') {
                    state.user = res.data; 
                    
                    Swal.fire({
                        icon: 'success',
                        title: `Halo, ${state.user.nama}`,
                        text: 'Login berhasil.',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    // Update Info User di Navbar
                    document.getElementById('namaSiswaDisplay').innerText = state.user.nama;
                    document.getElementById('kelasSiswaDisplay').innerText = state.user.kelas || '-';
                    document.getElementById('user-info').style.setProperty('display', 'flex', 'important');
                    
                    switchView('view-dashboard');
                    loadMapel();
                } else {
                    Swal.fire('Login Gagal', res.message || 'Cek Username/Password', 'error');
                }
            } catch (err) {
                Swal.fire('Error', 'Gagal terhubung ke server.', 'error');
            }
        });

        // --- 2. DASHBOARD MAPEL ---
        async function loadMapel() {
            const listDiv = document.getElementById('listMapel');
            listDiv.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted">Memuat daftar ujian...</p></div>';
            
            const res = await apiRequest({ action: 'getMapelSiswa', payload: { nama: state.user.nama } });
            listDiv.innerHTML = '';

            if (res.status === 'success') {
                if(res.data.length === 0) {
                    listDiv.innerHTML = '<div class="alert alert-info w-100 text-center">Belum ada ujian yang aktif saat ini.</div>';
                    return;
                }

                res.data.forEach(m => {
                    let btnAction = '';
                    let cardStyle = 'card-mapel';
                    let statusBadge = '';

                    if (m.sudah_dikerjakan) {
                        cardStyle = 'card h-100 p-3 card-done border';
                        statusBadge = '<span class="badge bg-success float-end"><i class="fas fa-check"></i> Selesai</span>';
                        btnAction = `<button class="btn btn-secondary w-100" disabled>SUDAH DIKERJAKAN</button>`;
                    } else {
                        cardStyle = 'card h-100 p-3 card-mapel border-primary';
                        statusBadge = '<span class="badge bg-warning text-dark float-end"><i class="fas fa-clock"></i> Tersedia</span>';
                        btnAction = `<button class="btn btn-primary w-100 fw-bold shadow-sm" onclick="mulaiUjian('${m.id}', '${m.nama}', ${m.durasi})">KERJAKAN <i class="fas fa-arrow-right"></i></button>`;
                    }

                    listDiv.innerHTML += `
                    <div class="col-md-6 col-lg-4">
                        <div class="${cardStyle}">
                            <div class="mb-3 border-bottom pb-2">
                                <small class="text-muted fw-bold">MAPEL</small>
                                ${statusBadge}
                                <h5 class="fw-bold mt-1 text-dark">${m.nama}</h5>
                            </div>
                            <div class="mb-3">
                                <p class="small text-muted mb-1"><i class="fas fa-align-left"></i> ${m.deskripsi}</p>
                                <p class="small text-muted"><i class="fas fa-stopwatch"></i> Waktu: <b>${m.durasi} Menit</b></p>
                            </div>
                            <div class="mt-auto">
                                ${btnAction}
                            </div>
                        </div>
                    </div>`;
                });
            } else {
                listDiv.innerHTML = '<div class="alert alert-danger">Gagal memuat data ujian.</div>';
            }
        }

        // --- 3. FITUR ANTI CURANG ---
        document.addEventListener("visibilitychange", function() {
            if (document.hidden && state.isUjianAktif) {
                handleKecurangan();
            }
        });

        function handleKecurangan() {
            state.pelanggaran++;
            const maxNyawa = 3;
            const sisaNyawa = maxNyawa - state.pelanggaran;
            
            if (sisaNyawa > 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'PERINGATAN KERAS!',
                    html: `Anda terdeteksi pindah tab/aplikasi!<br>Jangan lakukan lagi atau ujian akan dihentikan otomatis.<br><b>Sisa kesempatan: ${sisaNyawa} kali</b>`,
                    confirmButtonText: 'Saya Mengerti',
                    allowOutsideClick: false
                });
            } else {
                state.isUjianAktif = false;
                clearInterval(state.timerInterval);
                Swal.fire({
                    icon: 'error',
                    title: 'DISKUALIFIKASI',
                    text: 'Anda melakukan pelanggaran berulang kali. Jawaban akan dikirim otomatis.',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    timer: 3000
                }).then(() => {
                    kirimJawaban(true); 
                });
            }
        }

        // --- 4. LOGIKA UJIAN ---

        async function mulaiUjian(id, namaMapel, durasiMenit) {
            Swal.fire({
                title: 'Konfirmasi Ujian',
                html: `Siap mengerjakan <b>${namaMapel}</b>?<br>Waktu: ${durasiMenit} menit.<br><br><span class="text-danger fw-bold"><i class="fas fa-exclamation-triangle"></i> DILARANG PINDAH TAB/APLIKASI</span>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ya, Mulai!',
                cancelButtonText: 'Batal'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.showLoading();
                    const res = await apiRequest({ action: 'getSoal', payload: { pelajaran_id: id } });
                    
                    if (res.status === 'success') {
                        state.mapel = { id: id, nama: namaMapel };
                        state.soal = res.data;
                        state.jawaban = {};
                        state.durasi = durasiMenit * 60;
                        state.pelanggaran = 0;
                        state.isUjianAktif = true; 
                        
                        setupUjianUI();
                        switchView('view-ujian');
                        Swal.close();
                        
                        try { document.documentElement.requestFullscreen(); } catch(e){}

                        startTimer();
                        renderSoal(0);
                    } else {
                        Swal.fire('Gagal', res.message, 'error');
                    }
                }
            });
        }

        function setupUjianUI() {
            document.getElementById('mapel-label').innerText = state.mapel.nama;
            
            const navDiv = document.getElementById('nav-soal');
            navDiv.innerHTML = '';
            state.soal.forEach((_, idx) => {
                navDiv.innerHTML += `<button id="nav-btn-${idx}" onclick="renderSoal(${idx})" class="btn btn-outline-secondary btn-sm fw-bold" style="width: 40px; margin-bottom:5px;">${idx + 1}</button>`;
            });
        }

        function renderSoal(index) {
            currentSoalIndex = index;
            const soal = state.soal[index];
            const totalSoal = state.soal.length;
            
            document.getElementById('no-soal').innerText = index + 1;
            
            document.getElementById('btn-prev').disabled = (index === 0);
            document.getElementById('btn-next').disabled = (index === totalSoal - 1);
            
            const divSoal = document.getElementById('soal-container');
            divSoal.innerHTML = soal.pertanyaan.replace(/\n/g, "<br>"); 

            document.querySelectorAll('#nav-soal button').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-btn-${index}`).classList.add('active'); 

            const divOpsi = document.getElementById('opsi-container');
            divOpsi.innerHTML = '';
            
            ['a', 'b', 'c', 'd'].forEach(opt => {
                const val = opt.toUpperCase();
                const textOpsi = soal['opsi_' + opt];
                const isSelected = state.jawaban[index] === val ? 'active' : '';
                
                divOpsi.innerHTML += `
                <button onclick="pilihJawaban(${index}, '${val}')" class="btn btn-light opsi-btn ${isSelected} w-100 d-flex align-items-center">
                    <span class="fw-bold me-3 bg-white border rounded px-2 py-1 text-dark">${val}</span>
                    <span class="text-start flex-grow-1">${textOpsi}</span>
                </button>`;
            });
        }

        function navigasiSoal(arah) {
            const nextIndex = currentSoalIndex + arah;
            if (nextIndex >= 0 && nextIndex < state.soal.length) {
                renderSoal(nextIndex);
            }
        }

        function pilihJawaban(index, jawab) {
            state.jawaban[index] = jawab;
            
            const navBtn = document.getElementById(`nav-btn-${index}`);
            navBtn.classList.remove('btn-outline-secondary', 'btn-warning');
            navBtn.classList.add('btn-primary', 'text-white');
            
            renderSoal(index); 
        }

        function raguRagu() {
            const navBtn = document.getElementById(`nav-btn-${currentSoalIndex}`);
            navBtn.className = 'btn btn-warning btn-sm text-dark fw-bold';
        }

        // --- 5. TIMER & SUBMIT ---
        function startTimer() {
            clearInterval(state.timerInterval);
            const display = document.getElementById('timer');
            
            state.timerInterval = setInterval(() => {
                state.durasi--;
                
                const h = Math.floor(state.durasi / 3600);
                const m = Math.floor((state.durasi % 3600) / 60);
                const s = state.durasi % 60;
                display.innerText = `${h}:${m<10?'0':''}${m}:${s<10?'0':''}${s}`;
                
                if (state.durasi <= 0) {
                    clearInterval(state.timerInterval);
                    state.isUjianAktif = false;
                    Swal.fire('Waktu Habis', 'Jawaban akan dikirim otomatis.', 'info').then(() => {
                        kirimJawaban(true);
                    });
                }
            }, 1000);
        }

        function selesaiUjian() {
            const dijawab = Object.keys(state.jawaban).length;
            const total = state.soal.length;
            
            let pesan = `Anda baru menjawab <b>${dijawab}</b> dari <b>${total}</b> soal.`;
            if(dijawab === total) pesan = "Pastikan jawaban Anda sudah benar.";

            Swal.fire({
                title: 'Selesai Ujian?',
                html: pesan,
                icon: dijawab < total ? 'warning' : 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Kirim Nilai',
                cancelButtonText: 'Cek Lagi'
            }).then((res) => {
                if (res.isConfirmed) kirimJawaban();
            });
        }

        async function kirimJawaban(auto = false) {
            state.isUjianAktif = false; 
            clearInterval(state.timerInterval);
            
            if (document.fullscreenElement) {
                try { await document.exitFullscreen(); } catch(e){}
            }

            Swal.fire({ title: 'Menghitung Nilai...', text: 'Jangan tutup halaman ini', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            const payload = {
                pelajaran_id: state.mapel.id,
                nama: state.user.nama,
                kelas: state.user.kelas, 
                jawaban_user: state.jawaban 
            };

            try {
                const res = await apiRequest({ action: 'submitJawaban', payload: payload });
                
                if (res.status === 'success') {
                    let judul = auto ? 'Waktu Habis / Diskualifikasi' : 'Ujian Selesai!';
                    Swal.fire({
                        title: judul,
                        html: `Nilai Anda:<br><h1 class="display-1 text-primary fw-bold my-3">${res.skor}</h1>`,
                        icon: 'success',
                        allowOutsideClick: false,
                        confirmButtonText: 'Kembali ke Dashboard'
                    }).then(() => {
                        state.mapel = null;
                        state.soal = [];
                        state.jawaban = {};
                        switchView('view-dashboard');
                        loadMapel(); 
                    });
                } else {
                    Swal.fire('Gagal Menyimpan', res.message, 'error');
                }
            } catch (e) {
                Swal.fire('Error Koneksi', 'Gagal mengirim jawaban. Cek internet Anda.', 'error');
            }
        }

        // --- HELPER FUNCTIONS ---
        function switchView(viewId) {
            document.querySelectorAll('.main-container > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        function logout() {
            state.user = null;
            document.getElementById('formLogin').reset();
            document.getElementById('user-info').style.setProperty('display', 'none', 'important');
            // Reset ikon mata jika sedang terbuka
            document.getElementById('password').type = 'password';
            document.getElementById('iconPass').classList.remove('fa-eye-slash');
            document.getElementById('iconPass').classList.add('fa-eye');
            switchView('view-login');
        }

        async function apiRequest(body) {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(body)
            });
            return await response.json();
        }
    </script>
</body>
</html>
